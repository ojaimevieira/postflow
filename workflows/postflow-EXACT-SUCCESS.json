{
  "name": "üöÄ PostFlow - EXACT USER SUCCESS VERSION",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "triggerAtSecond": 30
            }
          ]
        }
      },
      "id": "090cc930-fe2c-44cd-b70e-3f6995434c2c",
      "name": "Schedule Trigger (Every 30s)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -112,
        256
      ]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "notionApi",
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "1c868fa96b0480a5ad81f57648a2392c",
        "limit": 5,
        "filterType": "manual",
        "matchType": "allFilters",
        "conditions": {
          "conditions": [
            {
              "key": "Status",
              "condition": "equals",
              "value": "Agendado"
            }
          ]
        },
        "options": {}
      },
      "id": "a8c45c48-83f9-43ae-800b-6306b2f8991f",
      "name": "Query Notion (Native + Filtered)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        96,
        256
      ]
    },
    {
      "parameters": {
        "jsCode": "// PostFlow URL-BASED - Using direct URLs from Notion\nconst items = $input.all();\nconst readyPosts = [];\n\nconsole.log(`üöÄ URL-BASED WORKFLOW - Processing ${items.length} items`);\n\n// Get current date/time for comparison\nconst now = new Date();\nconsole.log(`üïí Current time: ${now.toISOString()}`);\nconsole.log(`üåç Current time (Local): ${now.toLocaleString('pt-BR')}`);\n\nfor (const item of items) {\n  const data = item.json;\n  \n  console.log('\\n=== üöÄ Processing Notion page (URL-BASED) ===');\n  console.log('Raw data structure:', JSON.stringify(Object.keys(data), null, 2));\n  \n  // Use correct property_* format\n  const postTitle = data.property_nome || data.name || 'Untitled Post';\n  console.log(`üìù Post: \"${postTitle}\"`);\n  console.log(`üÜî Page ID: ${data.id}`);\n  \n  // Check all conditions using property_* format\n  const status = data.property_status;\n  console.log(`üìä Status: ${status}`);\n  if (status !== 'Agendado') {\n    console.log(`‚ùå SKIP: Status is \"${status}\", not \"Agendado\"`);\n    continue;\n  }\n  \n  const shouldPublish = data.property_publicar;\n  console.log(`‚úÖ Publicar?: ${shouldPublish}`);\n  if (!shouldPublish) {\n    console.log('‚ùå SKIP: Publicar? is false');\n    continue;\n  }\n  \n  // Handle platform array format\n  const platforms = data.property_plataforma || [];\n  let platformNames = [];\n  let hasInstagram = false;\n  \n  if (Array.isArray(platforms)) {\n    platformNames = platforms;\n    hasInstagram = platforms.includes('Instagram');\n  } else if (typeof platforms === 'string') {\n    platformNames = [platforms];\n    hasInstagram = platforms === 'Instagram';\n  }\n  \n  console.log(`üéØ Platforms: [${platformNames.join(', ')}]`);\n  \n  if (!hasInstagram) {\n    console.log('‚ùå SKIP: No Instagram platform');\n    continue;\n  }\n  \n  // Check scheduled date\n  const scheduledDateData = data.property_data_do_agendamento;\n  console.log(`üìÖ Scheduled date data:`, scheduledDateData);\n  \n  if (!scheduledDateData) {\n    console.log('‚ùå SKIP: No scheduled date set');\n    continue;\n  }\n  \n  // Parse scheduled date\n  let scheduledDate;\n  \n  if (typeof scheduledDateData === 'object' && scheduledDateData.start) {\n    const scheduledStart = scheduledDateData.start;\n    if (scheduledStart.includes('T')) {\n      scheduledDate = new Date(scheduledStart);\n    } else {\n      scheduledDate = new Date(scheduledStart + 'T09:00:00');\n    }\n  } else if (typeof scheduledDateData === 'string') {\n    scheduledDate = new Date(scheduledDateData);\n  } else {\n    console.log('‚ùå SKIP: Invalid scheduled date format');\n    continue;\n  }\n  \n  console.log(`üìÖ Scheduled for: ${scheduledDate.toISOString()}`);\n  console.log(`üìÖ Scheduled for (Local): ${scheduledDate.toLocaleString('pt-BR')}`);\n  \n  // Check if it's time to publish\n  const isTimeToPublish = now >= scheduledDate;\n  console.log(`‚è∞ Time check: ${isTimeToPublish ? '‚úÖ READY' : '‚ùå NOT YET'}`);\n  \n  if (!isTimeToPublish) {\n    const timeUntil = scheduledDate - now;\n    const hoursUntil = Math.round(timeUntil / (1000 * 60 * 60) * 10) / 10;\n    console.log(`‚è≥ SKIP: Still ${hoursUntil} hours until scheduled time`);\n    continue;\n  }\n  \n  // Extract post data using property_* format\n  const postText = data.property_texto_do_post || '';\n  \n  // Handle hashtags array format\n  let hashtags = '';\n  if (data.property_hashtags) {\n    if (Array.isArray(data.property_hashtags)) {\n      hashtags = data.property_hashtags.map(tag => tag.startsWith('#') ? tag : `#${tag}`).join(' ');\n    } else if (typeof data.property_hashtags === 'string') {\n      hashtags = data.property_hashtags.startsWith('#') ? data.property_hashtags : `#${data.property_hashtags}`;\n    }\n  }\n  \n  // Get media URL from Notion (now expecting URL instead of file)\n  const mediaUrls = data.property_m_dia || [];\n  console.log(`üì¶ Media URLs:`, mediaUrls);\n  \n  if (!mediaUrls || mediaUrls.length === 0) {\n    console.log(`‚ùå SKIP: Post \"${postTitle}\" has no media URLs`);\n    continue;\n  }\n  \n  // Get the first media URL\n  let mediaUrl = Array.isArray(mediaUrls) ? mediaUrls[0] : mediaUrls;\n  console.log(`üîó Media URL: ${mediaUrl}`);\n  \n  if (!mediaUrl || typeof mediaUrl !== 'string') {\n    console.log(`‚ùå SKIP: Invalid media URL format`);\n    continue;\n  }\n  \n  // Add http:// if missing\n  if (!mediaUrl.startsWith('http://') && !mediaUrl.startsWith('https://')) {\n    mediaUrl = 'http://' + mediaUrl;\n    console.log(`ÔøΩ Fixed Media URL: ${mediaUrl}`);\n  }\n  \n  // Detect media type from URL\n  const mediaType = mediaUrl.toLowerCase().includes('.mp4') || \n                   mediaUrl.toLowerCase().includes('.mov') || \n                   mediaUrl.toLowerCase().includes('.avi') ? 'REELS' : 'IMAGE';\n  \n  const caption = postText + (hashtags ? '\\n\\n' + hashtags : '');\n  \n  console.log(`üöÄ POST APPROVED: \"${postTitle}\" ready for Instagram ${mediaType} posting!`);\n  console.log(`ÔøΩ Media URL: ${mediaUrl}`);\n  \n  readyPosts.push({\n    notion_page_id: data.id,\n    post_title: postTitle,\n    caption: caption,\n    media_type: mediaType,\n    media_url: mediaUrl,\n    scheduled_date: scheduledDate.toISOString(),\n    // Preserve original data\n    _preserve_notion_id: data.id,\n    _preserve_title: postTitle\n  });\n}\n\nconsole.log(`\\nüöÄ === URL-BASED RESULT ===`);\nconsole.log(`üìä Total posts ready for Instagram: ${readyPosts.length}`);\nif (readyPosts.length > 0) {\n  console.log('üöÄ Posts that will be published NOW:');\n  readyPosts.forEach((post, i) => {\n    console.log(`   ${i+1}. \"${post.post_title}\" [${post.media_type}] (${post.media_url})`);\n  });\n} else {\n  console.log('‚è≥ No posts ready to publish at this time. Next check in 30 seconds.');\n}\n\nreturn readyPosts;"
      },
      "id": "f3319254-656b-4e17-af86-c5a8501c925d",
      "name": "Process Posts (WORKING)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        256
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "video-detection",
              "leftValue": "={{ $json.media_type }}",
              "rightValue": "REELS",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "eade2d9b-541b-4345-be0f-b1310593e65f",
      "name": "Is Video? (WORKING)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        544,
        256
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/17841468923069540/media",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAgHDLKanTYBPZAw4VZCP8vp2DjVuIRCjPz04uqUczYg2fEfBO3FO1rZCW0LY80Bco8ZAIZAbZA8LqrJQ8ZCN74fUOBOMfdgZBtO37JgfCpyaJAFFwGYVHDIqB0riJTOo5ohAVi7xGrwMnpgGTSMCGW3EJyZAI9dVcDZAPVdXzjOsawmHUHazG2rUExshml73BfkE7jdhZAX1ZAPrpNFJE3dCXdXGOdaEOyB5Ew4ih2GXqpzQRvH7QEieTTYbZBzFtq0ZD"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "media_type",
              "value": "REELS"
            },
            {
              "name": "video_url", 
              "value": "={{ $json.media_url }}"
            },
            {
              "name": "caption",
              "value": "={{ $json.caption }}"
            }
          ]
        },
        "options": {}
      },
      "id": "9bc467af-9b24-4169-ab44-dc939ff7a492",
      "name": "Upload Video to Instagram (WORKING)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        768,
        176
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/17841468923069540/media",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAgHDLKanTYBPZAw4VZCP8vp2DjVuIRCjPz04uqUczYg2fEfBO3FO1rZCW0LY80Bco8ZAIZAbZA8LqrJQ8ZCN74fUOBOMfdgZBtO37JgfCpyaJAFFwGYVHDIqB0riJTOo5ohAVi7xGrwMnpgGTSMCGW3EJyZAI9dVcDZAPVdXzjOsawmHUHazG2rUExshml73BfkE7jdhZAX1ZAPrpNFJE3dCXdXGOdaEOyB5Ew4ih2GXqpzQRvH7QEieTTYbZBzFtq0ZD"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "image_url",
              "value": "={{ $json.media_url }}"
            },
            {
              "name": "caption",
              "value": "={{ $json.caption }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5aafb820-5d93-42be-ac54-0333f402a354",
      "name": "Upload Image to Instagram (WORKING)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        768,
        336
      ]
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "seconds"
      },
      "id": "wait-for-video-processing",
      "name": "Wait for Video Processing (30s)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        880,
        176
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/17841468923069540/media_publish",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer EAAgHDLKanTYBPZAw4VZCP8vp2DjVuIRCjPz04uqUczYg2fEfBO3FO1rZCW0LY80Bco8ZAIZAbZA8LqrJQ8ZCN74fUOBOMfdgZBtO37JgfCpyaJAFFwGYVHDIqB0riJTOo5ohAVi7xGrwMnpgGTSMCGW3EJyZAI9dVcDZAPVdXzjOsawmHUHazG2rUExshml73BfkE7jdhZAX1ZAPrpNFJE3dCXdXGOdaEOyB5Ew4ih2GXqpzQRvH7QEieTTYbZBzFtq0ZD"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "creation_id",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1b399596-0f95-4533-ac98-1a3a184fb6b0",
      "name": "Publish to Instagram (WORKING)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        992,
        176
      ]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "notionApi",
        "resource": "page",
        "operation": "update",
        "pageId": "={{ $json._preserve_notion_id }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Status",
              "selectValue": "Publicado"
            },
            {
              "key": "Link da Publica√ß√£o",
              "urlValue": "={{ $json.permalink }}"
            }
          ]
        }
      },
      "id": "2de41cbd-2592-439d-8456-784bce15c2c4",
      "name": "Update Notion Status (WORKING)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        1216,
        256
      ]
    }
  ],
  "connections": {
    "Schedule Trigger (Every 30s)": {
      "main": [
        [
          {
            "node": "Query Notion (Native + Filtered)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Notion (Native + Filtered)": {
      "main": [
        [
          {
            "node": "Process Posts (WORKING)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Posts (WORKING)": {
      "main": [
        [
          {
            "node": "Is Video? (WORKING)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Video? (WORKING)": {
      "main": [
        [
          {
            "node": "Upload Video to Instagram (WORKING)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Upload Image to Instagram (WORKING)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Video to Instagram (WORKING)": {
      "main": [
        [
          {
            "node": "Wait for Video Processing (30s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Video Processing (30s)": {
      "main": [
        [
          {
            "node": "Publish to Instagram (WORKING)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Image to Instagram (WORKING)": {
      "main": [
        [
          {
            "node": "Publish to Instagram (WORKING)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Publish to Instagram (WORKING)": {
      "main": [
        [
          {
            "node": "Update Notion Status (WORKING)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-09-02T01:15:00.000Z",
  "versionId": "exact-success-v1"
}
